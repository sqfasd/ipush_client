!function(t,e){function n(t){if(t)try{this.data_=JSON.parse(t)}catch(e){console.error("parse message failed",e),this.data_={}}else this.data_={}}function s(t){return t instanceof Function}function o(t){var e="";for(var n in t){var s=t[n];e+=n,e+="=",e+=s,e+="&"}return"&"==e.charAt(e.length-1)&&(e=e.slice(0,-1)),e}function i(e,i){if(this.uid=i.uid,this.password=i.password,this.sock_,this.address_=e,this.full_url_,this.keepAliveTimer_,this.onOpen=function(){},this.onError=function(t){},this.onClose=function(){},this.onMessage=function(t){},!this.uid||!this.password||!this.address_)throw new Error("invalid parameters");if(this.full_url_="ws://"+e+"/connect?"+o(i),console.log("full_url_ = ",this.full_url_),!t||!t.WebSocket)throw new Error("WebSocket not support");this.sock_=new t.WebSocket(this.full_url_),this.sock_.onopen=function(){console.log("websocket onopen"),s(this.onOpen)&&(this.onOpen(),this.restartKeepAlive())}.bind(this),this.sock_.onmessage=function(t){console.log("websocket onmessage",t);try{var e=new n(t.data);this.sendAck(e.seq()),s(this.onMessage)&&this.onMessage(e)}catch(t){s(this.onError)&&this.onError(new Error("message format error"))}}.bind(this),this.sock_.onclose=function(t){console.log("websocket closed",t),this.keepAliveTimer_&&(console.log("clear keepalive timer"),clearInterval(this.keepAliveTimer_)),s(this.onClose)&&this.onClose()}.bind(this)}var r=1,a=2,c=3,u=4,h=5,p="f",l="t",d="s",f="y",_="u",k="c",y="b",v=3e4;n.prototype.toString=function(){return JSON.stringify(this.data_)},n.prototype.serialize=function(){return JSON.stringify(this.data_)},n.prototype.setFrom=function(t){this.data_[p]=t},n.prototype.from=function(){return this.data_[p]},n.prototype.setTo=function(t){this.data_[l]=t},n.prototype.to=function(){return this.data_[l]},n.prototype.setSeq=function(t){this.data_[d]=t},n.prototype.seq=function(){return this.data_[d]},n.prototype.setType=function(t){this.data_[f]=t},n.prototype.type=function(){return this.data_[f]},n.prototype.setUser=function(t){this.data_[_]=t},n.prototype.user=function(){return this.data_[_]},n.prototype.setChannel=function(t){this.data_[k]=t},n.prototype.channel=function(){return this.data_[k]},n.prototype.setBody=function(t){this.data_[y]=t},n.prototype.body=function(){return this.data_[y]};var b={heartbeatPacket:function(){return" "},sendPacket:function(t,e){var s=new n;return s.setType(c),s.setBody(t),s.setTo(e),s.serialize()},publishPacket:function(t,e){var s=new n;return s.setType(u),s.setBody(t),s.setChannel(e),s.serialize()},subPacket:function(t,e){var s=new n;return s.setType(r),s.setChannel(t),s.setUser(e),s.serialize()},unsubPacket:function(t,e){var s=new n;return s.setType(a),s.setChannel(t),s.setUser(e),s.serialize()},ackPacket:function(t){var e=new n;return e.setType(h),e.setSeq(t),e.serialize()}};i.prototype.restartKeepAlive=function(){this.keepAliveTimer_&&clearInterval(this.keepAliveTimer_),this.keepAliveTimer_=setInterval(function(){console.log("send heartbeat"),this.sendPacket(b.heartbeatPacket())}.bind(this),v)},i.prototype.sendPacket=function(t){this.restartKeepAlive(),this.sock_.send(t)},i.prototype.send=function(t,e){this.sendPacket(b.sendPacket(t,e))},i.prototype.publish=function(t,e){this.sendPacket(b.publishPacket(t,e))},i.prototype.sub=function(t){this.sendPacket(b.subPacket(this.channelId,this.uid))},i.prototype.unsub=function(t){this.sendPacket(b.unsubPacket(this.channelId,this.uid))},i.prototype.close=function(){this.sock_.close()},i.prototype.sendAck=function(t){this.sendPacket(b.ackPacket(t))},t.XCometClient=i,t.XCometMessage=n}(window);