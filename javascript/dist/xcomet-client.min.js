!function(t,e){function o(t){if(t)try{this.data_=JSON.parse(t)}catch(e){console.error("parse message failed",e),this.data_={}}else this.data_={}}function n(t){return t instanceof Function}function s(t){var e="";for(var o in t){var n=t[o];e+=o,e+="=",e+=n,e+="&"}return"&"==e.charAt(e.length-1)&&(e=e.slice(0,-1)),e}function r(e,r){if(this.uid=r.uid,this.password=r.password,this.sock_,this.address_=e,this.full_url_,this.keepAliveTimer_,this.onOpen=function(){},this.onError=function(t){},this.onClose=function(){},this.onMessage=function(t){},!this.uid||!this.password||!this.address_)throw new Error("uid or password must be provided");if(this.full_url_="ws://"+e+"/connect?"+s(r),console.log("full_url_ = ",this.full_url_),!t||!t.WebSocket)throw new Error("WebSocket not support");this.sock_=new t.WebSocket(this.full_url_),this.sock_.onopen=function(){console.log("websocket onopen"),n(this.onOpen)&&(this.onOpen(),this.restartKeepAlive())}.bind(this),this.sock_.onmessage=function(t){console.log("websocket onmessage",t);try{var e=new o(t.data);n(this.onMessage)&&this.onMessage(e)}catch(t){n(this.onError)&&this.onError(new Error("message format error"))}}.bind(this),this.sock_.onclose=function(t){console.log("websocket closed",t),this.keepAliveTimer_&&(console.log("clear keepalive timer"),clearInterval(this.keepAliveTimer_)),n(this.onClose)&&this.onClose()}.bind(this)}var i=1,a=2,c=3,u=4,p=6,h=7,d=8,l=9,f=10,y=11,k="f",_="t",m="s",v="y",P="u",w="c",b="b",g="r",T="k",S="v",z=3e4;o.prototype.isNormalMessage=function(){return this.data_[v]==c},o.prototype.isChannelMessage=function(){return this.data_[v]==u},o.prototype.isRoomSendMessage=function(){return this.data_[v]==l},o.prototype.isRoomBroadcastMessage=function(){return this.data_[v]==f},o.prototype.toString=function(){return JSON.stringify(this.data_)},o.prototype.serialize=function(){return JSON.stringify(this.data_)},o.prototype.setFrom=function(t){this.data_[k]=t},o.prototype.from=function(){return this.data_[k]},o.prototype.setTo=function(t){this.data_[_]=t},o.prototype.to=function(){return this.data_[_]},o.prototype.setSeq=function(t){this.data_[m]=t},o.prototype.seq=function(){return this.data_[m]},o.prototype.setType=function(t){this.data_[v]=t},o.prototype.type=function(){return this.data_[v]},o.prototype.setUser=function(t){this.data_[P]=t},o.prototype.user=function(){return this.data_[P]},o.prototype.setChannel=function(t){this.data_[w]=t},o.prototype.channel=function(){return this.data_[w]},o.prototype.setBody=function(t){this.data_[b]=t},o.prototype.body=function(){return this.data_[b]},o.prototype.setRoom=function(t){this.data_[g]=t},o.prototype.room=function(){return this.data_[g]},o.prototype.setKey=function(t){this.data_[T]=t},o.prototype.key=function(){return this.data_[T]},o.prototype.setValue=function(t){this.data_[S]=t},o.prototype.value=function(){return this.data_[S]};var C={heartbeatPacket:function(){return" "},sendPacket:function(t,e){var n=new o;return n.setType(c),n.setBody(t),n.setTo(e),n.serialize()},publishPacket:function(t,e){var n=new o;return n.setType(u),n.setBody(t),n.setChannel(e),n.serialize()},subPacket:function(t,e){var n=new o;return n.setType(i),n.setChannel(t),n.setUser(e),n.serialize()},unsubPacket:function(t,e){var n=new o;return n.setType(a),n.setChannel(t),n.setUser(e),n.serialize()},roomJoinPacket:function(t){var e=new o;return e.setType(p),e.setRoom(t),e.serialize()},roomLeavePacket:function(t){var e=new o;return e.setType(h),e.setRoom(t),e.serialize()},roomKickPacket:function(t,e){var n=new o;return n.setType(d),n.setRoom(t),n.setUser(e),n.serialize()},roomSendPacket:function(t,e,n){var s=new o;return s.setType(l),s.setRoom(t),s.setTo(n),s.setBody(e),s.serialize()},roomBroadcastPacket:function(t,e){var n=new o;return n.setType(f),n.setRoom(t),n.setBody(e),n.serialize()},roomSetPacket:function(t,e,n){var s=new o;return s.setType(y),s.setRoom(t),s.setKey(e),s.setValue(n),s.serialize()}};r.prototype.restartKeepAlive=function(){this.keepAliveTimer_&&clearInterval(this.keepAliveTimer_),this.keepAliveTimer_=setInterval(function(){console.log("send heartbeat"),this.sendPacket(C.heartbeatPacket())}.bind(this),z)},r.prototype.sendPacket=function(t){this.restartKeepAlive(),this.sock_.send(t)},r.prototype.send=function(t,e){this.sendPacket(C.sendPacket(t,e))},r.prototype.publish=function(t,e){this.sendPacket(C.publishPacket(t,e))},r.prototype.sub=function(t){this.sendPacket(C.subPacket(this.channelId,this.uid))},r.prototype.unsub=function(t){this.sendPacket(C.unsubPacket(this.channelId,this.uid))},r.prototype.roomJoin=function(t){this.sendPacket(C.roomJoinPacket(t))},r.prototype.roomLeave=function(t){this.sendPacket(C.roomLeavePacket(t))},r.prototype.roomKick=function(t,e){this.sendPacket(C.roomKickPacket(t,this.memberId))},r.prototype.roomSend=function(t,e,o){this.sendPacket(C.roomSendPacket(t,e,o))},r.prototype.roomBroadcast=function(t,e){this.sendPacket(C.roomBroadcastPacket(t,e))},r.prototype.roomSet=function(t,e,o){this.sendPacket(C.roomSetPacket(t,e,o))},r.prototype.roomState=function(t,e){console.error("fixme")},r.prototype.close=function(){this.sock_.close()},t.XCometClient=r,t.XCometMessage=o}(window);